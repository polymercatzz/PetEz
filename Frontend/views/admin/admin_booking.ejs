<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>sidebar</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- <script src="./tailwind3.js"></script> -->
  <link
    href="https://fonts.googleapis.com/css2?family=Kanit:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
</head>

<body class="font-[kanit]">
  <%- include('../partials/admin-sidebar', { activeMenu: 'bookings' }) %>

  <div class="ml-[310px] max-[1024px]:m-4 max-[1024px]:mt-20 lg:pt-4 lg:px-6">
    <div>
      <p class="text-[#000000] text-[4vh]">จัดการผู้ใช้</p>
      <p class="text-[#6E6E6E] text-[2.3vh]">ผู้ใช้และพี่เลี้ยงทั้งหมดของระบบ</p>
    </div>

    <div class="p-5 min-h-screen bg-white border border-gray-200 rounded-xl mt-4 mb-6">
      <div class="flex space-x-6 text-[2vh]">
        <select id="statusFilter" class="px-2 border border-gray-300 rounded-xl text-center">
          <option value="">ทั้งหมด</option>
          <option value="pending">รออนุมัติ</option>
          <option value="confirmed">ยืนยันแล้ว</option>
          <option value="in_progress">กำลังดำเนินการ</option>
          <option value="completed">เสร็จสิ้น</option>
          <option value="cancelled">ยกเลิก</option>
        </select>
        <button id="statusSearchBtn" class="px-4 py-2 bg-blue-600 text-white rounded-xl">ค้นหา</button>
        <script>
          document.getElementById('statusSearchBtn').onclick = function() {
            const status = document.getElementById('statusFilter').value;
            document.querySelectorAll('tbody tr').forEach(tr => {
              const statusText = tr.querySelector('.accountStatus')?.textContent.trim() || '';
              let show = false;
              if (!status) show = true;
              else if (
                (status === 'pending' && statusText === 'รออนุมัติ') ||
                (status === 'confirmed' && statusText === 'ยืนยันแล้ว') ||
                (status === 'in_progress' && statusText === 'กำลังดำเนินการ') ||
                (status === 'completed' && statusText === 'เสร็จสิ้น') ||
                (status === 'cancelled' && statusText === 'ยกเลิก')
              ) show = true;
              tr.style.display = show ? '' : 'none';
            });
          };
        </script>
      </div>
      <div class="overflow-auto rounded-lg shadow hidden md:block">
        <table class="w-full">
          <thead class="bg-gray-50 border-b-2 border-gray-200">
            <tr>
              <th class="w-20 p-3 text-[1.2rem] font-medium tracking-wide text-left text-gray-600">ID</th>
              <th class="p-3 text-[1.2rem] font-medium tracking-wide text-left text-gray-600">วันที่ใช้บริการ</th>
              <th class="p-3 text-[1.2rem] font-medium tracking-wide text-left text-gray-600">ผู้ใช้</th>
              <th class="w-24 p-3 text-[1.2rem] font-medium tracking-wide text-left text-gray-600">พี่เลี้ยง</th>
              <th class="w-24 p-3 text-[1.2rem] font-medium tracking-wide text-left text-gray-600">บริการ</th>
              <th class="p-3 text-[1.2rem] font-medium tracking-wide text-left text-gray-600">เบอร์โทร</th>
              <th class="w-24p-3 text-[1.2rem] font-medium tracking-wide text-left text-gray-600">ราคา</th>
              <th class="w-24 p-3 text-[1.2rem] font-medium tracking-wide text-left text-gray-600">Status</th>
              <th class="p-3 text-[1.2rem] font-medium tracking-wide text-left text-gray-600">จัดการ</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-100">
            <% const statusMap = {
                pending: { label: 'รออนุมัติ', cls: 'bg-yellow-400' },
                confirmed: { label: 'ยืนยันแล้ว', cls: 'bg-blue-500' },
                in_progress: { label: 'กำลังดำเนินการ', cls: 'bg-blue-600' },
                completed: { label: 'เสร็จสิ้น', cls: 'bg-green-600' },
                cancelled: { label: 'ยกเลิก', cls: 'bg-red-600' }
            }; %>
            <% (bookings || []).forEach(b => { const st = statusMap[b.status] || statusMap.pending; %>
              <tr class="bg-white">
                <td class="p-3 text-[2vh] text-gray-700 whitespace-nowrap"><%= b.booking_id %></td>
                <td class="p-3 text-[2vh] text-gray-700 whitespace-nowrap">
                  <%= new Date(b.start_date).toLocaleString('th-TH') %> - <%= new Date(b.end_date).toLocaleString('th-TH') %>
                </td>
                <td class="p-3 text-[2vh] text-gray-700 whitespace-nowrap">#<%= b.user_id %></td>
                <td class="p-3 text-[2vh] text-gray-700 whitespace-nowrap"><%= b.sitter_id ? ('#' + b.sitter_id) : '-' %></td>
                <td class="p-3 text-[2vh] text-gray-700 whitespace-nowrap"><%= b.service_type %></td>
                <td class="p-3 text-[2vh] text-gray-700 whitespace-nowrap"><%= b.emergency_contact || '-' %></td>
                <td class="p-3 text-[2vh] text-gray-700 whitespace-nowrap"><%= Number(b.total_price || 0).toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></td>
                <td class="p-3 text-[2vh] text-gray-700 whitespace-nowrap">
                  <span class="accountStatus px-3 py-1 text-[1.7vh] font-medium tracking-wider text-white rounded-lg <%= st.cls %>"><%= st.label %></span>
                </td>
                <td class="p-3 text-[2vh] text-gray-700 whitespace-nowrap justify-center flex">
                  <button class="openPopup" data-booking='<%- JSON.stringify(b) %>'>
                    <i class="bi bi-three-dots-vertical cursor-pointe"></i>
                  </button>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>


      <div class="grid grid-cols-1  gap-4 md:hidden">


        <div class="res bg-white space-y-3 p-4 rounded-lg shadow-lg">
          <div class="flex">
            <div class="flex items-center space-x-4 text-[2vh]">
              <div>
                <p href="#" class="text-blue-500 font-bold hover:underline">ID:1000</p>
              </div>
              <div>
                <span
                  class="accountStatus px-3 py-1 text-[1.7vh] font-medium  tracking-wider text-white bg-yellow-400 rounded-lg ">รออนุมัติ</span>
              </div>
            </div>
            <div class="ml-auto">
                <button class="openPopup" data-booking='{}'>
                  <i class="bi bi-three-dots-vertical cursor-pointe"></i>
                </button>
            </div>
          </div>
          <div class="text-[2vh] text-gray-700 space-y-2">
            <p>วันที่ใช้บริการ: 01/12/2025 - 12/12/2025</p>
            <p>ผู้ใช้: Kittipich Hirunwong</p>
            <div class="flex justify-between">
              <p>พี่เลี้ยง: พีท</p>
              <p>บริการ: ฝากเลี้ยง</p>
            </div>
            <div class="flex justify-between mr-6">
              <p>Phone: 087-716-0351</p>
              <p>ราคา: 2,000</p>
            </div>
          </div>
        </div>

        <div class="res bg-white space-y-3 p-4 rounded-lg shadow-lg">
          <div class="flex">
            <div class="flex items-center space-x-4 text-[2vh]">
              <div>
                <p href="#" class="text-blue-500 font-bold hover:underline">ID:1000</p>
              </div>
              <div>
                <span
                  class="accountStatus px-3 py-1 text-[1.7vh] font-medium  tracking-wider text-white bg-red-600 rounded-lg ">ยกเลิก</span>
              </div>
            </div>
            <div class="ml-auto">
                <button class="openPopup">
                  <i class="bi bi-three-dots-vertical cursor-pointe"></i>
                </button>
            </div>
          </div>
          <div class="text-[2vh] text-gray-700 space-y-2">
            <p>วันที่ใช้บริการ: 01/12/2025 - 12/12/2025</p>
            <p>ผู้ใช้: Kittipich Hirunwong</p>
            <div class="flex justify-between">
              <p>พี่เลี้ยง: พีท</p>
              <p>บริการ: ฝากเลี้ยง</p>
            </div>  
            <div class="flex justify-between mr-6">
              <p>Phone: 087-716-0351</p>
              <p>ราคา: 2,000</p>
            </div>
          </div>
        </div>

        <div class="res bg-white space-y-3 p-4 rounded-lg shadow-lg">
          <div class="flex">
            <div class="flex items-center space-x-4 text-[2vh]">
              <div>
                <p href="#" class="text-blue-500 font-bold hover:underline">ID:1000</p>
              </div>
              <div>
                <span
                  class="accountStatus p-1.5 text-[1.7vh] font-medium  tracking-wider text-white bg-green-600 rounded-lg ">เสร็จสิ้น</span>
              </div>
            </div>
            <div class="ml-auto">
                <button class="openPopup">
                  <i class="bi bi-three-dots-vertical cursor-pointe"></i>
                </button>
            </div>
          </div>
          <div class="text-[2vh] text-gray-700 space-y-2">
            <p>วันที่ใช้บริการ: 01/12/2025 - 12/12/2025</p>
            <p>ผู้ใช้: Kittipich Hirunwong</p>
            <div class="flex justify-between">
              <p>พี่เลี้ยง: พีท</p>
              <p>บริการ: ฝากเลี้ยง</p>
            </div>  
            <div class="flex justify-between mr-6">
              <p>Phone: 087-716-0351</p>
              <p>ราคา: 2,000</p>
            </div>
          </div>
        </div>





      </div>






      <!-- pop up -->
      <div id="popup"
        class="fixed inset-0 flex justify-center items-center bg-white/60 hidden z-[15000] backdrop-blur-sm">
        <div class="bg-white w-fit rounded-xl shadow-lg p-4 lg:p-8 relative animate-fadeIn m-4">

          <button id="closePopup" class="absolute top-4 right-4 text-gray-500 hover:text-black text-2xl">
            ✕
          </button>

          <p class="font-semibold mb-1 text-[3vh]">รายละเอียดการจอง</p>
          <p class="text-[2vh] text-gray-500 mb-4">ID #<span id="popupBookingId">-</span></p>

          <div class="space-y-2 text-[2vh] lg:m-8">
            <div class="grid grid-cols-2 lg:grid-cols-3 lg:gap-8">
              <div class="flex-row justify-center items-center">
                <p class="font-light text-[#7D7D7D]">ชื่อ-นามสกุล</p>
                <p class="font-medium" id="popupUserName">-</p>
              </div>
              <div class="flex-row justify-center items-center">
                <p class="font-light text-[#7D7D7D]">Email</p>
                <p class="font-medium" id="popupEmail">-</p>
              </div>
              <div class="flex-row justify-center items-center">
                <p class="font-light text-[#7D7D7D]">Phone</p>
                <p class="font-medium" id="popupPhone">-</p>
              </div>
            </div>
            <div class="grid grid-cols-2 lg:grid-cols-3 lg:gap-8">
              <div class="flex-row justify-center items-center">
                <p class="font-light text-[#7D7D7D]">พี่เลี้ยงสัตว์</p>
                <p class="font-medium" id="popupSitter">-</p>
              </div>
              <div class="flex-row justify-center items-center">
                <p class="font-light text-[#7D7D7D]">บริการ</p>
                <p class="font-medium" id="popupService">-</p>
              </div>
              <div class="flex-row justify-center items-center">
                <p class="font-light text-[#7D7D7D]">สถานที่</p>
                <p class="font-medium" id="popupLocation">-</p>
              </div>
            </div>
            <div class="grid grid-cols-2 lg:grid-cols-3 lg:gap-8">
              <div class="flex-row justify-center items-center">
                <p class="font-light text-[#7D7D7D]">วันที่ใช้บริการ</p>
                <p class="font-medium" id="popupDateRange">-</p>
              </div>
              <div class="flex-row justify-center items-center">
                <p class="font-light text-[#7D7D7D]">จำนวนวัน</p>
                <p class="font-medium" id="popupDays">-</p>
              </div>
              <div class="flex-row justify-center items-center">
                <p class="font-light text-[#7D7D7D]">ราคา</p>
                <p class="font-medium" id="popupPrice">-</p>
              </div>
            </div>
          </div>

          <div class="mt-6 text-[2vh]">
            <label for="status" class="font-medium">สถานะ</label>
            <select id="status"
              class="mt-1 w-full border rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-gray-400">
              <option value="pending">รออนุมัติ</option>
              <option value="confirmed">ยืนยันแล้ว</option>
              <option value="in_progress">กำลังดำเนินการ</option>
              <option value="completed">เสร็จสิ้น</option>
              <option value="cancelled">ยกเลิก</option>
            </select>
            <button id="saveStatusBtn" class="mt-3 px-4 py-2 bg-blue-600 text-white rounded-lg">บันทึก</button>
          </div>
        </div>
      </div>



      <script>
        // nav
        function Openbar() {
          document.querySelector('.sidebar').classList.toggle('left-[-300px]')
        }


        // popup description
  const popup = document.getElementById('popup');
  const closeBtn = document.getElementById('closePopup');
  const statusSelect = document.getElementById('status');
  const saveStatusBtn = document.getElementById('saveStatusBtn');
  const popupBookingId = document.getElementById('popupBookingId');
  let currentBooking = null;

        document.addEventListener('click', (e) => {
          // เปิด popup
          if (e.target.closest('.openPopup')) {
            const btn = e.target.closest('.openPopup');
            try { currentBooking = JSON.parse(btn.dataset.booking); } catch { currentBooking = null; }
            if (currentBooking) {
              popupBookingId.textContent = currentBooking.booking_id || '-';
              if (currentBooking.status) statusSelect.value = currentBooking.status;

              // Helper formatters
              const fmtTH = (d) => d ? new Date(d).toLocaleString('th-TH') : '-';
              const to2 = (n) => Number(n || 0).toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

              // Basic user/sitter/service info (fallback to IDs if names are unknown)
              document.getElementById('popupUserName').textContent = currentBooking.user_id ? `ผู้ใช้ #${currentBooking.user_id}` : '-';
              document.getElementById('popupEmail').textContent = '-';
              document.getElementById('popupPhone').textContent = currentBooking.emergency_contact || '-';
              document.getElementById('popupSitter').textContent = currentBooking.sitter_id ? `พี่เลี้ยง #${currentBooking.sitter_id}` : '-';
              document.getElementById('popupService').textContent = currentBooking.service_type || (currentBooking.service_id ? `บริการ #${currentBooking.service_id}` : '-');
              document.getElementById('popupLocation').textContent = currentBooking.location || '-';

              // Dates, days, price
              const sd = currentBooking.start_date ? new Date(currentBooking.start_date) : null;
              const ed = currentBooking.end_date ? new Date(currentBooking.end_date) : null;
              document.getElementById('popupDateRange').textContent = (sd && ed) ? `${fmtTH(sd)} - ${fmtTH(ed)}` : '-';
              if (sd && ed) {
                const diffMs = ed - sd;
                const days = Math.max(1, Math.ceil(diffMs / (1000 * 60 * 60 * 24)));
                document.getElementById('popupDays').textContent = `${days} วัน`;
              } else {
                document.getElementById('popupDays').textContent = '-';
              }
              document.getElementById('popupPrice').textContent = to2(currentBooking.total_price);
            }
            popup.classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
          }
          // ปิด popup
          if (e.target === popup || e.target === closeBtn) {
            popup.classList.add('hidden');
            document.body.classList.remove('overflow-hidden');
          }
        });

        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') {
            popup.classList.add('hidden');
            document.body.classList.remove('overflow-hidden');
          }
        });

        // change status
        if (saveStatusBtn) {
          saveStatusBtn.addEventListener('click', async () => {
            if (!currentBooking) return;
            const newStatus = statusSelect.value;
            try {
              const resp = await fetch(`/admin/api/bookings/${currentBooking.booking_id}/status`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: newStatus })
              });
              if (resp.ok) {
                window.location.reload();
              } else {
                const data = await resp.json().catch(() => ({ message: 'อัปเดตสถานะไม่สำเร็จ' }));
                alert(data.message || 'อัปเดตสถานะไม่สำเร็จ');
              }
            } catch (err) {
              alert('เกิดข้อผิดพลาดระหว่างอัปเดตสถานะ');
            }
          });
        }


      </script>



</body>
<style>
  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(30px);
    }

    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .animate-fadeIn {
    animation: fadeIn 0.3s ease-out;
  }
</style>

</html>