<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>sidebar</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- <script src="./tailwind3.js"></script> -->
  <link
    href="https://fonts.googleapis.com/css2?family=Kanit:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
</head>

<body class="font-[kanit]">
  <%- include('../partials/admin-sidebar', { activeMenu: 'users' }) %>
  <div class="ml-[310px] max-[1024px]:m-4 max-[1024px]:mt-20 lg:pt-4 lg:px-6">
    <div>
      <p class="text-[#000000] text-[4vh]">จัดการผู้ใช้</p>
      <p class="text-[#6E6E6E] text-[2.3vh]">ผู้ใช้และพี่เลี้ยงทั้งหมดของระบบ</p>
    </div>

    <div class="mt-7 text-[2.3vh]">
      <div class="shadow-sm p-1 rounded-lg border border-gray-200 inline-flex bg-[#EDEDED]">
        <button id="tab-users" class="bg-white rounded-lg mr-2 px-5 py-1" onclick="showTab('users')">Users</button>
        <button id="tab-sitters" class="text-gray-700 px-5 py-1 rounded-lg" onclick="showTab('sitters')">Pet Sitter</button>
      </div>
    </div>

    <div class="p-5 min-h-screen bg-white border border-gray-200 rounded-xl mt-4 mb-6">

      <div id="panel-users" class="overflow-auto rounded-lg shadow hidden md:block">
        <table class="w-full">
          <thead class="bg-gray-50 border-b-2 border-gray-200">
            <tr>
              <th class="w-20 p-3 text-[1.2rem] font-medium tracking-wide text-left text-gray-600">ID</th>
              <th class="p-3 text-[1.2rem] font-medium tracking-wide text-left text-gray-600">Name</th>
              <th class="p-3 text-[1.2rem] font-medium tracking-wide text-left text-gray-600">Email</th>
              <th class="p-3 text-[1.2rem] font-medium tracking-wide text-left text-gray-600">Phone</th>
              <th class="w-24 p-3 text-[1.2rem] font-medium tracking-wide text-left text-gray-600">Status</th>
              <th class="w-24 p-3 text-[1.2rem] font-medium tracking-wide text-left text-gray-600">Role</th>
              <th class="w-30 p-3 text-[1.2rem] font-medium tracking-wide text-left text-gray-600">Start Date</th>
              <th class=" p-3 text-[1.2rem] font-medium tracking-wide text-left text-gray-600">Action</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-100">
            <% (users || []).forEach(function(u){ %>
              <tr class="bg-white" data-user-id="<%= u.user_id %>">
                <td class="p-3 text-[2vh] text-gray-700 whitespace-nowrap">
                  <p class="hover:underline"><%= u.user_id %></p>
                </td>
                <td class="p-3 text-[2vh] text-gray-700 whitespace-nowrap">
                  <%= u.full_name || u.username || '-' %>
                </td>
                <td class="p-3 text-[2vh] text-gray-700 whitespace-nowrap">
                  <%= u.email || '-' %>
                </td>
                <td class="p-3 text-[2vh] text-gray-700 whitespace-nowrap">
                  <%= u.phone || '-' %>
                </td>
                <td class="p-3 text-[2vh] text-gray-700 whitespace-nowrap">
                  <span class="accountStatus p-1.5 text-[1.7vh] font-medium tracking-wider text-white <%= (u.status === 'active' ? 'bg-blue-600' : (u.status === 'suspended' ? 'bg-red-600' : 'bg-gray-500')) %> rounded-lg">
                    <%= u.status === 'active' ? 'กำลังใช้งาน' : (u.status === 'suspended' ? 'ถูกระงับ' : 'ไม่ทราบสถานะ') %>
                  </span>
                </td>
                <td class="p-3 text-[2vh] text-gray-700 whitespace-nowrap"><%= (u.createdAt && new Date(u.createdAt).toLocaleDateString('th-TH')) || '-' %></td>
                <td class="p-3 text-[2vh] text-gray-700 whitespace-nowrap">
                  <select class="roleSelect border rounded px-2 py-1" onchange="changeRole(this)" data-current-role="<%= u.role %>">
                    <option value="user" <%= u.role==='user'?'selected':'' %>>user</option>
                    <option value="sitter" <%= u.role==='sitter'?'selected':'' %>>sitter</option>
                    <option value="admin" <%= u.role==='admin'?'selected':'' %>>admin</option>
                  </select>
                </td>
                <td class="p-3 text-[2vh] text-gray-700 whitespace-nowrap justify-center flex">
                  <div>
                    <div onclick="toggleDropdown(event)">
                      <i class="bi bi-three-dots-vertical cursor-pointe"></i>
                    </div>
                    <div class="dropDown absolute rounded-xl border bg-white p-3 right-20 select-none hidden">
                      <button onclick="changeStatus('active',this)" class="flex text-[2vh] mb-2 cursor-pointer hover:bg-gray-100 p-2 rounded-xl">
                        <i class="bi bi-power mr-1"></i>
                        <p>Activate Account</p>
                      </button>
                      <button onclick="changeStatus('suspend',this)" class="flex text-[2vh] mb-2 cursor-pointer hover:bg-gray-100 p-2 rounded-xl">
                        <i class="bi bi-x-circle mr-1 "></i>
                        <p>Suspend Account</p>
                      </button>
                      <button onclick="changeStatus('delete',this)" class="flex text-[2vh] text-red-500 cursor-pointer hover:bg-gray-100 p-2 rounded-xl">
                        <i class="bi bi-trash-fill mr-1 "></i>
                        <p>Delete Account</p>
                      </button>
                    </div>
                  </div>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>

      <div id="panel-sitters" class="overflow-auto rounded-lg shadow hidden md:block" style="display:none">
        <table class="w-full">
          <thead class="bg-gray-50 border-b-2 border-gray-200">
            <tr>
              <th class="w-20 p-3 text-[1.2rem] font-medium tracking-wide text-left text-gray-600">ID</th>
              <th class="p-3 text-[1.2rem] font-medium tracking-wide text-left text-gray-600">Name</th>
              <th class="p-3 text-[1.2rem] font-medium tracking-wide text-left text-gray-600">Email</th>
              <th class="p-3 text-[1.2rem] font-medium tracking-wide text-left text-gray-600">Phone</th>
              <th class="w-24 p-3 text-[1.2rem] font-medium tracking-wide text-left text-gray-600">Status</th>
              <th class="w-24 p-3 text-[1.2rem] font-medium tracking-wide text-left text-gray-600">Role</th>
              <th class="w-30 p-3 text-[1.2rem] font-medium tracking-wide text-left text-gray-600">Start Date</th>
              <th class=" p-3 text-[1.2rem] font-medium tracking-wide text-left text-gray-600">Action</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-100">
            <% (sitters || []).forEach(function(s){ %>
              <tr class="bg-white" data-user-id="<%= s.user_id %>">
                <td class="p-3 text-[2vh] text-gray-700 whitespace-nowrap">
                  <p class="hover:underline"><%= s.user_id %></p>
                </td>
                <td class="p-3 text-[2vh] text-gray-700 whitespace-nowrap">
                  <%= s.full_name || s.username || '-' %>
                </td>
                <td class="p-3 text-[2vh] text-gray-700 whitespace-nowrap">
                  <%= s.email || '-' %>
                </td>
                <td class="p-3 text-[2vh] text-gray-700 whitespace-nowrap">
                  <%= s.phone || '-' %>
                </td>
                <td class="p-3 text-[2vh] text-gray-700 whitespace-nowrap">
                  <span class="accountStatus p-1.5 text-[1.7vh] font-medium tracking-wider text-white <%= (s.status === 'active' ? 'bg-blue-600' : (s.status === 'suspended' ? 'bg-red-600' : 'bg-gray-500')) %> rounded-lg">
                    <%= s.status === 'active' ? 'กำลังใช้งาน' : (s.status === 'suspended' ? 'ถูกระงับ' : 'ไม่ทราบสถานะ') %>
                  </span>
                </td>
                <td class="p-3 text-[2vh] text-gray-700 whitespace-nowrap"><%= (s.createdAt && new Date(s.createdAt).toLocaleDateString('th-TH')) || '-' %></td>
                <td class="p-3 text-[2vh] text-gray-700 whitespace-nowrap">
                  <select class="roleSelect border rounded px-2 py-1" onchange="changeRole(this)" data-current-role="<%= s.role %>">
                    <option value="user" <%= s.role==='user'?'selected':'' %>>user</option>
                    <option value="sitter" <%= s.role==='sitter'?'selected':'' %>>sitter</option>
                    <option value="admin" <%= s.role==='admin'?'selected':'' %>>admin</option>
                  </select>
                </td>
                <td class="p-3 text-[2vh] text-gray-700 whitespace-nowrap justify-center flex">
                  <div>
                    <div onclick="toggleDropdown(event)">
                      <i class="bi bi-three-dots-vertical cursor-pointe"></i>
                    </div>
                    <div class="dropDown absolute rounded-xl border bg-white p-3 right-20 select-none hidden">
                      <button onclick="changeStatus('active',this)" class="flex text-[2vh] mb-2 cursor-pointer hover:bg-gray-100 p-2 rounded-xl">
                        <i class="bi bi-power mr-1"></i>
                        <p>Activate Account</p>
                      </button>
                      <button onclick="changeStatus('suspend',this)" class="flex text-[2vh] mb-2 cursor-pointer hover:bg-gray-100 p-2 rounded-xl">
                        <i class="bi bi-x-circle mr-1 "></i>
                        <p>Suspend Account</p>
                      </button>
                      <button onclick="changeStatus('delete',this)" class="flex text-[2vh] text-red-500 cursor-pointer hover:bg-gray-100 p-2 rounded-xl">
                        <i class="bi bi-trash-fill mr-1 "></i>
                        <p>Delete Account</p>
                      </button>
                    </div>
                  </div>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>

      <div class="grid grid-cols-1 gap-4 md:hidden">
        <div id="card-users" class="space-y-3">
          <% (users || []).forEach(function(u){ %>
            <div class="res bg-white space-y-3 p-4 rounded-lg shadow-lg" data-user-id="<%= u.user_id %>">
              <div class="flex">
                <div class="flex items-center space-x-4 text-[2vh]">
                  <div>
                    <p class="text-blue-500 font-bold">ID:<%= u.user_id %></p>
                  </div>
                  <div class="text-gray-500"><%= (u.createdAt && new Date(u.createdAt).toLocaleDateString('th-TH')) || '-' %></div>
                  <div>
                    <span class="accountStatus p-1.5 text-[1.7vh] font-medium tracking-wider text-white <%= (u.status === 'active' ? 'bg-blue-600' : (u.status === 'suspended' ? 'bg-red-600' : 'bg-gray-500')) %> rounded-lg">
                      <%= u.status === 'active' ? 'กำลังใช้งาน' : (u.status === 'suspended' ? 'ถูกระงับ' : 'ไม่ทราบสถานะ') %>
                    </span>
                  </div>
                </div>
                <div class="ml-auto">
                  <div class="">
                    <div onclick="toggleDropdown(event)">
                      <i class="bi bi-three-dots-vertical cursor-pointe"></i>
                    </div>
                    <div class="dropDown absolute rounded-xl border bg-white p-3 right-10 select-none hidden">
                      <button onclick="changeStatus('active',this)" class="flex text-[2vh] mb-2 cursor-pointer hover:bg-gray-100 p-2 rounded-xl">
                        <i class="bi bi-power mr-1"></i>
                        <p>Activate Account</p>
                      </button>
                      <button onclick="changeStatus('suspend',this)" class="flex text-[2vh] mb-2 cursor-pointer hover:bg-gray-100 p-2 rounded-xl">
                        <i class="bi bi-x-circle mr-1 "></i>
                        <p>Suspend Account</p>
                      </button>
                      <button onclick="changeStatus('delete',this)" class="flex text-[2vh] text-red-500 cursor-pointer hover:bg-gray-100 p-2 rounded-xl">
                        <i class="bi bi-trash-fill mr-1 "></i>
                        <p>Delete Account</p>
                      </button>
                    </div>
                  </div>
                </div>
              </div>

              <div class="text-[2vh] text-gray-700 space-y-2">
                <p>Name: <%= u.full_name || u.username || '-' %></p>
                <p>Email: <%= u.email || '-' %></p>
                <p>Phone: <%= u.phone || '-' %></p>
                <div class="mt-2">
                  <label class="mr-2 text-gray-600">Role</label>
                  <select class="roleSelect border rounded px-2 py-1" onchange="changeRole(this)" data-current-role="<%= u.role %>">
                    <option value="user" <%= u.role==='user'?'selected':'' %>>user</option>
                    <option value="sitter" <%= u.role==='sitter'?'selected':'' %>>sitter</option>
                    <option value="admin" <%= u.role==='admin'?'selected':'' %>>admin</option>
                  </select>
                </div>
              </div>
            </div>
          <% }) %>
        </div>

        <div id="card-sitters" class="space-y-3" style="display:none">
          <% (sitters || []).forEach(function(s){ %>
            <div class="res bg-white space-y-3 p-4 rounded-lg shadow-lg" data-user-id="<%= s.user_id %>">
              <div class="flex">
                <div class="flex items-center space-x-4 text-[2vh]">
                  <div>
                    <p class="text-blue-500 font-bold">ID:<%= s.user_id %></p>
                  </div>
                  <div class="text-gray-500"><%= (s.createdAt && new Date(s.createdAt).toLocaleDateString('th-TH')) || '-' %></div>
                  <div>
                    <span class="accountStatus p-1.5 text-[1.7vh] font-medium tracking-wider text-white <%= (s.status === 'active' ? 'bg-blue-600' : (s.status === 'suspended' ? 'bg-red-600' : 'bg-gray-500')) %> rounded-lg">
                      <%= s.status === 'active' ? 'กำลังใช้งาน' : (s.status === 'suspended' ? 'ถูกระงับ' : 'ไม่ทราบสถานะ') %>
                    </span>
                  </div>
                </div>
                <div class="ml-auto">
                  <div class="">
                    <div onclick="toggleDropdown(event)">
                      <i class="bi bi-three-dots-vertical cursor-pointe"></i>
                    </div>
                    <div class="dropDown absolute rounded-xl border bg-white p-3 right-10 select-none hidden">
                      <button onclick="changeStatus('active',this)" class="flex text-[2vh] mb-2 cursor-pointer hover:bg-gray-100 p-2 rounded-xl">
                        <i class="bi bi-power mr-1"></i>
                        <p>Activate Account</p>
                      </button>
                      <button onclick="changeStatus('suspend',this)" class="flex text-[2vh] mb-2 cursor-pointer hover:bg-gray-100 p-2 rounded-xl">
                        <i class="bi bi-x-circle mr-1 "></i>
                        <p>Suspend Account</p>
                      </button>
                      <button onclick="changeStatus('delete',this)" class="flex text-[2vh] text-red-500 cursor-pointer hover:bg-gray-100 p-2 rounded-xl">
                        <i class="bi bi-trash-fill mr-1 "></i>
                        <p>Delete Account</p>
                      </button>
                    </div>
                  </div>
                </div>
              </div>

              <div class="text-[2vh] text-gray-700 space-y-2">
                <p>Name: <%= s.full_name || s.username || '-' %></p>
                <p>Email: <%= s.email || '-' %></p>
                <p>Phone: <%= s.phone || '-' %></p>
                <div class="mt-2">
                  <label class="mr-2 text-gray-600">Role</label>
                  <select class="roleSelect border rounded px-2 py-1" onchange="changeRole(this)" data-current-role="<%= s.role %>">
                    <option value="user" <%= s.role==='user'?'selected':'' %>>user</option>
                    <option value="sitter" <%= s.role==='sitter'?'selected':'' %>>sitter</option>
                    <option value="admin" <%= s.role==='admin'?'selected':'' %>>admin</option>
                  </select>
                </div>
              </div>
            </div>
          <% }) %>
        </div>
      </div>





      </div>
    </div>



  </div>

  <script>
    // nav
    function dropDown() {
      const submenu = document.querySelector('#submenu');
      const arrow = document.querySelector('#arrow');
      if (submenu) submenu.classList.toggle('hidden');
      if (arrow) arrow.classList.toggle('rotate-0');
    }
    dropDown()
    function Openbar() {
      document.querySelector('.sidebar').classList.toggle('left-[-300px]')
    }

    // tabs
    function showTab(tab) {
      const usersPanel = document.getElementById('panel-users');
      const sittersPanel = document.getElementById('panel-sitters');
      const usersCard = document.getElementById('card-users');
      const sittersCard = document.getElementById('card-sitters');
      const tabUsers = document.getElementById('tab-users');
      const tabSitters = document.getElementById('tab-sitters');

      if (tab === 'sitters') {
        if (usersPanel) usersPanel.style.display = 'none';
        if (sittersPanel) sittersPanel.style.display = '';
        if (usersCard) usersCard.style.display = 'none';
        if (sittersCard) sittersCard.style.display = '';
        if (tabUsers) tabUsers.classList.remove('bg-white');
        if (tabSitters) tabSitters.classList.add('bg-white');
      } else {
        if (usersPanel) usersPanel.style.display = '';
        if (sittersPanel) sittersPanel.style.display = 'none';
        if (usersCard) usersCard.style.display = '';
        if (sittersCard) sittersCard.style.display = 'none';
        if (tabUsers) tabUsers.classList.add('bg-white');
        if (tabSitters) tabSitters.classList.remove('bg-white');
      }
    }

    // default to show users tab
    showTab('users');

    // dropdown
// toggle dropdown menu เฉพาะแถวที่คลิก
  function toggleDropdown(event) {
    event.stopPropagation();
    const btn = event.currentTarget;
    const menu = btn.parentElement.querySelector('.dropDown'); 

    // ซ่อน dropdown อื่นทั้งหมดก่อน
    document.querySelectorAll('.dropDown').forEach(d => {
      if (d !== menu) d.classList.add('hidden');
    });

    // toggle ของปุ่มนี้เท่านั้น
    menu.classList.toggle('hidden');
  }

  async function changeStatus(status, button) {
    const container = button.closest('tr') || button.closest('.res');
    if (!container) return;
    const userId = container.getAttribute('data-user-id');
    if (!userId) return;

    const dropdown = container.querySelector('.dropDown');

    try {
      if (status === 'delete') {
        const resp = await fetch(`/admin/api/users/${userId}`, { method: 'DELETE' });
        if (!resp.ok) throw new Error('Delete failed');
        // remove row/card from UI
        container.remove();
      } else if (status === 'active' || status === 'suspend') {
        const newStatus = status === 'active' ? 'active' : 'suspended';
        const resp = await fetch(`/admin/api/users/${userId}/status`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status: newStatus })
        });
        if (!resp.ok) throw new Error('Update status failed');

        // Update UI badge
        const statusSpan = container.querySelector('.accountStatus');
        if (statusSpan) {
          if (newStatus === 'active') {
            statusSpan.textContent = 'กำลังใช้งาน';
            statusSpan.className = 'accountStatus p-1.5 text-[1.7vh] font-medium tracking-wider text-white bg-blue-600 rounded-lg';
          } else {
            statusSpan.textContent = 'ถูกระงับ';
            statusSpan.className = 'accountStatus p-1.5 text-[1.7vh] font-medium tracking-wider text-white bg-red-600 rounded-lg';
          }
        }
      }
    } catch (e) {
      alert('ดำเนินการไม่สำเร็จ กรุณาลองใหม่อีกครั้ง');
      console.error(e);
    } finally {
      if (dropdown) dropdown.classList.add('hidden');
    }
  }

  // ปิด dropdown ถ้าคลิกนอก
  window.addEventListener('click', () => {
    document.querySelectorAll('.dropDown').forEach(d => d.classList.add('hidden'));
  });
   </script>
  <script>
    async function changeRole(selectEl) {
      const container = selectEl.closest('tr') || selectEl.closest('.res');
      if (!container) return;
      const userId = container.getAttribute('data-user-id');
      if (!userId) return;
      const newRole = selectEl.value;
      const prevRole = selectEl.getAttribute('data-current-role');
      if (newRole === prevRole) return;
      try {
        const resp = await fetch(`/admin/api/users/${userId}/role`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ role: newRole })
        });
        if (!resp.ok) {
          const data = await resp.json().catch(()=>({message:'Update role failed'}));
          alert(data.message || 'Update role failed');
          selectEl.value = prevRole; // revert
          return;
        }
        selectEl.setAttribute('data-current-role', newRole);
      } catch (err) {
        alert('เกิดข้อผิดพลาดระหว่างการอัปเดตสิทธิ์');
        selectEl.value = prevRole;
      }
    }
  </script>
</body>

</html>