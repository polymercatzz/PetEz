<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %> - PetEz</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@100..900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: "Noto Sans Thai", sans-serif;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <div class="flex justify-between items-center bg-white h-20 px-10 py-4 shadow-[0_2px_4px_rgba(0,0,0,0.3)] z-50">
        <a href="/petsitter" class="flex justify-center items-center gap-4">
            <i class="fa-solid fa-paw fa-3x text-blue-600"></i>
            <h1 class="text-[2.2rem] font-bold">PetEz</h1>
        </a>
        <div class="flex justify-center items-center gap-5">
            <a href="/petsitter/jobs" class="text-[1.2rem] underline-offset-4 hover:underline cursor-pointer">งานที่มี</a>
            <a href="/petsitter/history" class="nav-link text-[1.2rem] underline-offset-4 hover:underline cursor-pointer">ประวัติการให้บริการ</a>
            <div class="relative group">
                <img src="/static/user.png" class="w-12 h-12 rounded-full cursor-pointer">
                <div class="absolute right-0 top-[60px] w-[200px] bg-white border rounded-lg shadow-lg invisible opacity-0 group-hover:visible group-hover:opacity-100 transition-all duration-200 z-10">
                    <ul class="list-none p-2 m-0">
                        <li>
                            <a href="/petsitter/profile" class="flex items-center gap-4 w-full px-3 py-2 text-[1rem] rounded-md hover:bg-blue-100 transition-colors">
                                <i class="fa-solid fa-user"></i>
                                โปรไฟล์
                            </a>
                        </li>
                        <li>
                            <a href="/logout" class="flex items-center gap-4 w-full px-3 py-2 text-[1rem] rounded-md hover:bg-red-100 transition-colors">
                                <i class="fa-solid fa-right-from-bracket"></i>
                                ออกจากระบบ
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container mx-auto px-4 py-8">
        <div class="max-w-6xl mx-auto">
            <h1 class="text-3xl font-bold text-gray-800 mb-8">โปรไฟล์ Pet Sitter</h1>
            
            <!-- Profile Status -->
            <div id="profileStatus" class="mb-6"></div>
            
            <!-- Not Registered Section -->
            <div id="notRegisteredSection" class="hidden bg-blue-50 border border-blue-200 rounded-lg p-6 mb-6">
                <div class="text-center">
                    <i class="fa-solid fa-heart text-4xl text-blue-600 mb-4"></i>
                    <h2 class="text-xl font-semibold text-gray-800 mb-2">ยังไม่ได้สมัครเป็น Pet Sitter</h2>
                    <p class="text-gray-600 mb-4">เริ่มต้นการเป็น Pet Sitter และสร้างรายได้จากความรักในสัตว์เลี้ยง</p>
                    <a href="/petsitter/register" class="inline-block px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-colors">
                        <i class="fa-solid fa-plus mr-2"></i>สมัครเป็น Pet Sitter
                    </a>
                </div>
            </div>

            <!-- Profile Information -->
            <div id="profileSection" class="hidden grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Left Column - Profile Info -->
                <div class="lg:col-span-1">
                    <!-- Basic Info Card -->
                    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                        <div class="text-center mb-4">
                            <img src="/static/user.png" class="w-24 h-24 rounded-full mx-auto mb-4">
                            <h2 class="text-xl font-semibold text-gray-800"><%= user.username %></h2>
                            <p class="text-gray-600"><%= user.email %></p>
                        </div>
                        
                        <div id="sitterInfo">
                            <!-- Sitter info will be loaded here -->
                        </div>
                        
                        <button id="editProfileBtn" class="w-full mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                            <i class="fa-solid fa-edit mr-2"></i>แก้ไขโปรไฟล์
                        </button>
                    </div>

                    <!-- Statistics Card -->
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">สถิติ</h3>
                        <div id="statisticsInfo">
                            <!-- Statistics will be loaded here -->
                        </div>
                    </div>
                </div>

                <!-- Right Column - Services & Jobs -->
                <div class="lg:col-span-2">
                    <!-- Services Card -->
                    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-gray-800">บริการที่ให้</h3>
                            <button id="addServiceBtn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                                <i class="fa-solid fa-plus mr-2"></i>เพิ่มบริการ
                            </button>
                        </div>
                        <div id="servicesContainer">
                            <!-- Services will be loaded here -->
                        </div>
                    </div>

                    <!-- Recent Jobs Card -->
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">งานล่าสุด</h3>
                        <div id="recentJobsContainer">
                            <!-- Recent jobs will be loaded here -->
                        </div>
                        <div class="mt-4 text-center">
                            <a href="/petsitter/history" class="text-blue-600 hover:underline">ดูประวัติงานทั้งหมด</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Service Modal -->
    <div id="serviceModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
            <h3 class="text-lg font-semibold mb-4" id="serviceModalTitle">เพิ่มบริการใหม่</h3>
            <form id="serviceForm">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ประเภทบริการ</label>
                        <select name="service_type" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            <option value="">เลือกประเภทบริการ</option>
                            <option value="walking">เดินเล่น</option>
                            <option value="sitting">ดูแลที่บ้าน</option>
                            <option value="boarding">ฝากเลี้ยงที่บ้าน</option>
                            <option value="grooming">อาบน้ำตัดขน</option>
                            <option value="training">ฝึกสัตว์</option>
                            <option value="veterinary_visit">พาหาหมอ</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ราคาต่อชั่วโมง (บาท)</label>
                        <input type="number" name="price_per_hour" min="50" max="2000" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">รายละเอียด</label>
                        <textarea name="description" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                    <div>
                        <label class="flex items-center">
                            <input type="checkbox" name="availability" checked class="mr-2">
                            <span class="text-sm text-gray-700">เปิดให้บริการ</span>
                        </label>
                    </div>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" id="cancelServiceBtn" class="px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50">ยกเลิก</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">บันทึก</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Loading -->
    <div id="loading" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6">
            <div class="flex items-center space-x-3">
                <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
                <span>กำลังโหลด...</span>
            </div>
        </div>
    </div>

    <script>
        let currentServiceId = null;

        // Load profile data on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadProfileData();
        });

        async function loadProfileData() {
            showLoading(true);
            try {
                const response = await fetch('/petsitter/api/profile');
                if (response.ok) {
                    const data = await response.json();
                    displayProfileData(data.sitter);
                    loadStatistics();
                    loadServices();
                    loadRecentJobs();
                } else if (response.status === 404) {
                    showNotRegisteredSection();
                } else {
                    throw new Error('Failed to load profile');
                }
            } catch (error) {
                console.error('Error loading profile:', error);
                showNotRegisteredSection();
            } finally {
                showLoading(false);
            }
        }

        function showNotRegisteredSection() {
            document.getElementById('notRegisteredSection').classList.remove('hidden');
            document.getElementById('profileSection').classList.add('hidden');
        }

        function displayProfileData(sitter) {
            document.getElementById('notRegisteredSection').classList.add('hidden');
            document.getElementById('profileSection').classList.remove('hidden');
            
            const statusHtml = getStatusBadge(sitter.approval_status);
            document.getElementById('profileStatus').innerHTML = statusHtml;
            
            const sitterInfoHtml = `
                <div class="space-y-3">
                    <div>
                        <label class="text-sm font-medium text-gray-700">ประสบการณ์</label>
                        <p class="text-gray-900">${sitter.experience} ปี</p>
                    </div>
                    <div>
                        <label class="text-sm font-medium text-gray-700">แนะนำตัว</label>
                        <p class="text-gray-900 text-sm">${sitter.bio || 'ยังไม่ได้เพิ่มข้อมูล'}</p>
                    </div>
                    <div class="flex items-center">
                        <i class="fa-solid fa-shield-halved mr-2 ${sitter.verified ? 'text-green-500' : 'text-gray-400'}"></i>
                        <span class="text-sm ${sitter.verified ? 'text-green-600' : 'text-gray-600'}">
                            ${sitter.verified ? 'ผู้ใช้ที่ยืนยันแล้ว' : 'ยังไม่ได้ยืนยัน'}
                        </span>
                    </div>
                </div>
            `;
            document.getElementById('sitterInfo').innerHTML = sitterInfoHtml;
        }

        function getStatusBadge(status) {
            const statusMap = {
                'pending': { text: 'รอการอนุมัติ', color: 'bg-yellow-100 text-yellow-800 border-yellow-300' },
                'approved': { text: 'อนุมัติแล้ว', color: 'bg-green-100 text-green-800 border-green-300' },
                'rejected': { text: 'ถูกปฏิเสธ', color: 'bg-red-100 text-red-800 border-red-300' }
            };
            
            const statusInfo = statusMap[status] || statusMap['pending'];
            return `
                <div class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium border ${statusInfo.color}">
                    <i class="fa-solid fa-circle-info mr-2"></i>
                    สถานะ: ${statusInfo.text}
                </div>
            `;
        }

        async function loadStatistics() {
            try {
                const response = await fetch('/petsitter/api/statistics');
                if (response.ok) {
                    const data = await response.json();
                    displayStatistics(data.statistics);
                }
            } catch (error) {
                console.error('Error loading statistics:', error);
            }
        }

        function displayStatistics(stats) {
            const statisticsHtml = `
                <div class="space-y-3">
                    <div class="flex justify-between">
                        <span class="text-gray-600">งานทั้งหมด</span>
                        <span class="font-semibold">${stats.total_jobs}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">งานที่เสร็จ</span>
                        <span class="font-semibold">${stats.completed_jobs}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">อัตราความสำเร็จ</span>
                        <span class="font-semibold text-green-600">${stats.success_rate}%</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">บริการที่เปิด</span>
                        <span class="font-semibold">${stats.active_services}</span>
                    </div>
                </div>
            `;
            document.getElementById('statisticsInfo').innerHTML = statisticsHtml;
        }

        async function loadServices() {
            try {
                const response = await fetch('/petsitter/api/services');
                if (response.ok) {
                    const data = await response.json();
                    displayServices(data.services);
                }
            } catch (error) {
                console.error('Error loading services:', error);
            }
        }

        function displayServices(services) {
            if (services.length === 0) {
                document.getElementById('servicesContainer').innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fa-solid fa-plus-circle text-4xl mb-2"></i>
                        <p>ยังไม่มีบริการ คลิกเพิ่มบริการเพื่อเริ่มต้น</p>
                    </div>
                `;
                return;
            }

            const servicesHtml = services.map(service => `
                <div class="border border-gray-200 rounded-lg p-4 mb-3">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="flex items-center mb-2">
                                <h4 class="font-medium text-gray-800">${getServiceTypeName(service.service_type)}</h4>
                                <span class="ml-2 px-2 py-1 rounded-full text-xs ${service.availability ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                                    ${service.availability ? 'เปิดให้บริการ' : 'ปิดให้บริการ'}
                                </span>
                            </div>
                            <p class="text-gray-600 text-sm mb-1">${service.description || 'ไม่มีรายละเอียด'}</p>
                            <p class="font-semibold text-blue-600">${service.price_per_hour} บาท/ชั่วโมง</p>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="editService(${service.service_id}, '${service.service_type}', ${service.price_per_hour}, '${service.description}', ${service.availability})" 
                                class="text-blue-600 hover:text-blue-800">
                                <i class="fa-solid fa-edit"></i>
                            </button>
                            <button onclick="deleteService(${service.service_id})" class="text-red-600 hover:text-red-800">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('servicesContainer').innerHTML = servicesHtml;
        }

        function getServiceTypeName(type) {
            const typeMap = {
                'walking': 'เดินเล่น',
                'sitting': 'ดูแลที่บ้าน',
                'boarding': 'ฝากเลี้ยงที่บ้าน',
                'grooming': 'อาบน้ำตัดขน',
                'training': 'ฝึกสัตว์',
                'veterinary_visit': 'พาหาหมอ'
            };
            return typeMap[type] || type;
        }

        async function loadRecentJobs() {
            try {
                const response = await fetch('/petsitter/api/bookings?limit=3');
                if (response.ok) {
                    const data = await response.json();
                    displayRecentJobs(data.jobs);
                }
            } catch (error) {
                console.error('Error loading recent jobs:', error);
            }
        }

        function displayRecentJobs(jobs) {
            if (jobs.length === 0) {
                document.getElementById('recentJobsContainer').innerHTML = `
                    <div class="text-center py-4 text-gray-500">
                        <p>ยังไม่มีงาน</p>
                    </div>
                `;
                return;
            }

            const jobsHtml = jobs.map(job => `
                <div class="border border-gray-200 rounded-lg p-3 mb-2">
                    <div class="flex justify-between items-center">
                        <div>
                            <h5 class="font-medium">${job.User?.first_name || 'ลูกค้า'}</h5>
                            <p class="text-sm text-gray-600">${job.Service?.service_type || 'บริการ'} - ${job.total_price} บาท</p>
                        </div>
                        <span class="px-2 py-1 rounded-full text-xs ${getStatusColor(job.status)}">
                            ${getStatusText(job.status)}
                        </span>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('recentJobsContainer').innerHTML = jobsHtml;
        }

        function getStatusColor(status) {
            const colorMap = {
                'pending': 'bg-yellow-100 text-yellow-800',
                'accepted': 'bg-blue-100 text-blue-800',
                'in_progress': 'bg-purple-100 text-purple-800',
                'completed': 'bg-green-100 text-green-800',
                'cancelled': 'bg-red-100 text-red-800'
            };
            return colorMap[status] || 'bg-gray-100 text-gray-800';
        }

        function getStatusText(status) {
            const textMap = {
                'pending': 'รอดำเนินการ',
                'accepted': 'รับงานแล้ว',
                'in_progress': 'กำลังดำเนินการ',
                'completed': 'เสร็จสิ้น',
                'cancelled': 'ยกเลิก'
            };
            return textMap[status] || status;
        }

        // Modal functions
        function showServiceModal(title = 'เพิ่มบริการใหม่') {
            currentServiceId = null;
            document.getElementById('serviceModalTitle').textContent = title;
            document.getElementById('serviceForm').reset();
            document.getElementById('serviceModal').classList.remove('hidden');
        }

        function hideServiceModal() {
            document.getElementById('serviceModal').classList.add('hidden');
        }

        function editService(id, type, price, description, availability) {
            currentServiceId = id;
            document.getElementById('serviceModalTitle').textContent = 'แก้ไขบริการ';
            
            const form = document.getElementById('serviceForm');
            form.service_type.value = type;
            form.price_per_hour.value = price;
            form.description.value = description || '';
            form.availability.checked = availability;
            
            document.getElementById('serviceModal').classList.remove('hidden');
        }

        async function deleteService(id) {
            if (!confirm('คุณต้องการลบบริการนี้หรือไม่?')) return;
            
            showLoading(true);
            try {
                const response = await fetch(`/petsitter/api/services/${id}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    loadServices();
                } else {
                    alert('เกิดข้อผิดพลาดในการลบบริการ');
                }
            } catch (error) {
                console.error('Error deleting service:', error);
                alert('เกิดข้อผิดพลาดในการเชื่อมต่อ');
            } finally {
                showLoading(false);
            }
        }

        function showLoading(show) {
            document.getElementById('loading').classList.toggle('hidden', !show);
        }

        // Event listeners
        document.getElementById('addServiceBtn').addEventListener('click', () => showServiceModal());
        document.getElementById('cancelServiceBtn').addEventListener('click', hideServiceModal);

        document.getElementById('serviceForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            showLoading(true);
            try {
                const formData = new FormData(this);
                const data = {
                    service_type: formData.get('service_type'),
                    price_per_hour: parseInt(formData.get('price_per_hour')),
                    description: formData.get('description'),
                    availability: formData.has('availability')
                };

                const url = currentServiceId 
                    ? `/petsitter/api/services/${currentServiceId}`
                    : '/petsitter/api/services';
                
                const method = currentServiceId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    hideServiceModal();
                    loadServices();
                    loadStatistics();
                } else {
                    const result = await response.json();
                    alert(result.message || 'เกิดข้อผิดพลาด');
                }
            } catch (error) {
                console.error('Error saving service:', error);
                alert('เกิดข้อผิดพลาดในการเชื่อมต่อ');
            } finally {
                showLoading(false);
            }
        });
    </script>
</body>
</html>