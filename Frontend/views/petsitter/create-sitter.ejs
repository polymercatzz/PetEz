<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>สร้างงานใหม่ - PetEz</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@100..900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body{
            font-family: "Noto Sans Thai", sans-serif;
        }
    </style>
    </head>
<body>
    <%- include('../partials/petsitter-nav') %>

    <div class="flex flex-col justify-center items-start my-10 mx-auto px-10 py-10 w-[80%] border border-gray-200 rounded-xl shadow-sm">
        <h1 class="text-[1.8rem] font-bold mb-5">สร้างบริการ</h1>
        <form id="serviceForm" class="w-full">
            <div class="w-full mb-4">
                <label for="service_type" class="flex items-center gap-3 text-lg">ประเภทงาน</label>
                <select id="service_type" name="service_type" required class="w-full border-2 border-[#e2e8f0] rounded-2xl text-[1rem] px-5 py-2 transition duration-300 ease-in-out focus:outline-none focus:border-[#3b5bdb] focus:shadow-[0_0_0_4px_rgba(59,91,219,0.1)]">
                        <option value="" disabled selected>เลือกประเภทงาน</option>
                        <option value="boarding">ฝากเลี้ยง</option>
                        <option value="walking">พาเดิน</option>
                        <option value="home_visit">ไปดูแลที่บ้าน</option>
                        <option value="bath">อาบน้ำ</option>
                </select>
            </div>
            <div class="w-full mb-4">
                <label for="price_per_hour" class="flex items-center gap-3 text-lg">ราคา/ชั่วโมง (บาท)</label>
                <input id="price_per_hour" name="price_per_hour" type="number" min="0" step="1" required placeholder="หน่วยเป็นบาท" class="w-full border-2 border-[#e2e8f0] rounded-2xl text-[1rem] px-5 py-2 transition duration-300 ease-in-out focus:outline-none focus:border-[#3b5bdb] focus:shadow-[0_0_0_4px_rgba(59,91,219,0.1)]" />
            </div>
            <div class="w-full mb-4">
                <label for="service_days" class="flex items-center gap-3 text-lg">วันที่ให้บริการ</label>
                <input id="service_days" type="text" placeholder="เช่น จันทร์ - ศุกร์" class="w-full border-2 border-[#e2e8f0] rounded-2xl text-[1rem] px-5 py-2 transition duration-300 ease-in-out focus:outline-none focus:border-[#3b5bdb] focus:shadow-[0_0_0_4px_rgba(59,91,219,0.1)]" />
            </div>
            <div class="w-full mb-4">
                <label for="service_time" class="flex items-center gap-3 text-lg">เวลาที่ให้บริการ</label>
                <input id="service_time" type="text" placeholder="เช่น 10:00น. - 20:00น." class="w-full border-2 border-[#e2e8f0] rounded-2xl text-[1rem] px-5 py-2 transition duration-300 ease-in-out focus:outline-none focus:border-[#3b5bdb] focus:shadow-[0_0_0_4px_rgba(59,91,219,0.1)]" />
            </div>
            <div class="w-full mb-4">
                <label for="description" class="flex items-center gap-3 text-lg">รายละเอียดเพิ่มเติม</label>
                <textarea id="description" name="description" rows="4" placeholder="อธิบายรายละเอียดบริการ เงื่อนไข หรือหมายเหตุ" class="w-full border-2 border-[#e2e8f0] rounded-2xl text-[1rem] px-5 py-2 transition duration-300 ease-in-out focus:outline-none focus:border-[#3b5bdb] focus:shadow-[0_0_0_4px_rgba(59,91,219,0.1)]"></textarea>
            </div>
            <div class="w-full mb-4 flex items-center gap-3">
                <input id="availability" name="availability" type="checkbox" checked class="w-5 h-5" />
                <label for="availability" class="text-lg">พร้อมให้บริการ</label>
            </div>
            <div id="formError" class="hidden w-full mb-4 text-red-600"></div>
            <div class="flex justify-end items-end gap-5 w-full mt-5">
                <a href="/petsitter/jobs"><button type="button" class="border border-vlue-600 bg-white px-10 py-2 text-blue-600 text-[1.2rem] rounded-xl cursor-pointer transition deration-200 ease-in-out hadow-[0_5px_15px_rgba(37,99,235,0.3)] hover:shadow-[0_8px_20px_rgba(37,99,235,0.4)] hover:border-blue-500">ยกเลิก</button></a>
                <button id="submitBtn" type="submit" class="bg-blue-600 px-10 py-2 text-white text-[1.2rem] rounded-xl shadow-sm cursor-pointer transition deration-200 ease-in-out hover:bg-blue-800">ยืนยัน</button>
            </div>
        </form>
    </div>

    <script>
        const form = document.getElementById('serviceForm');
        const errorBox = document.getElementById('formError');
        const submitBtn = document.getElementById('submitBtn');

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            errorBox.classList.add('hidden');
            errorBox.textContent = '';

            const service_type = document.getElementById('service_type').value;
            const priceInput = document.getElementById('price_per_hour');
            const price_per_hour = Number(priceInput.value);
            const service_days = document.getElementById('service_days').value.trim();
            const service_time = document.getElementById('service_time').value.trim();
            const description = document.getElementById('description').value.trim();
            const availability = document.getElementById('availability').checked;

            if (!service_type) {
                errorBox.textContent = 'กรุณาเลือกประเภทงาน';
                errorBox.classList.remove('hidden');
                return;
            }
            if (!Number.isFinite(price_per_hour) || price_per_hour < 0) {
                errorBox.textContent = 'กรุณากรอกราคาให้ถูกต้อง';
                errorBox.classList.remove('hidden');
                priceInput.focus();
                return;
            }

            // Merge schedule info into description for storage
            let fullDescription = description;
            if (service_days) fullDescription += (fullDescription ? '\n' : '') + `วันที่ให้บริการ: ${service_days}`;
            if (service_time) fullDescription += (fullDescription ? '\n' : '') + `เวลาที่ให้บริการ: ${service_time}`;

            submitBtn.disabled = true;
            submitBtn.classList.add('opacity-60');
            try {
                const resp = await fetch('/petsitter/api/services', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ service_type, price_per_hour, description: fullDescription, availability })
                });
                if (!resp.ok) {
                    const errData = await resp.json().catch(() => ({ message: 'สร้างบริการไม่สำเร็จ' }));
                    throw new Error(errData.message || 'สร้างบริการไม่สำเร็จ');
                }
                // Success
                alert('สร้างบริการสำเร็จ');
                window.location.href = '/petsitter/register';
            } catch (err) {
                errorBox.textContent = err.message || 'เกิดข้อผิดพลาดจากระบบ';
                errorBox.classList.remove('hidden');
            } finally {
                submitBtn.disabled = false;
                submitBtn.classList.remove('opacity-60');
            }
        });
    </script>
</body>
</html>