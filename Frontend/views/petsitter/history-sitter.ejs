<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PetEz</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@100..900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body{
            font-family: "Noto Sans Thai", sans-serif;
        }
        .scroll-container {
            overflow-x: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
            cursor: grab;
        }
        .scroll-container::-webkit-scrollbar {
            display: none;
        }
        
        .scroll-container:active {
            cursor: grabbing;
        }
    </style>
    </head>
<body>
    <%- include('../partials/petsitter-nav') %>

    <div class="flex flex-col justify-center items-start my-10 mx-auto px-10 py-10 w-[80%] border border-gray-200 rounded-xl shadow-sm">
        <div class="flex justify-center items-center gap-3 mb-5 text-red-500">
            <i class="fa-solid fa-bell fa-2x"></i>
            <p class="text-[1.8rem] font-bold">งานใหม่</p>
        </div>
        <div id="new-jobs" class="grid grid-cols-1 gap-5 w-full"></div>
    </div>

    <div class="flex flex-col justify-center items-start mb-10 mx-auto px-10 py-10 w-[80%] border border-gray-200 rounded-xl shadow-sm">
        <div class="flex justify-center items-center gap-3 mb-5 text-blue-500">
            <i class="fa-solid fa-clock-rotate-left fa-2x"></i>
            <p class="text-[1.8rem] font-bold">ประวัติการทำงาน</p>
        </div>
        <div id="history" class="grid grid-cols-1 gap-5 w-full"></div>
    </div>

    <div id="popup" class="hidden fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-100 bg-white py-5 rounded-xl flex flex-col justify-center items-start w-[50%] mx-auto shadow-[0_4px_12px_rgba(0,0,0,0.15)]">
        <p class="px-3 py-1 bg-green-100 text-green-800 mb-3 rounded-xl mx-3">บริการดูแลสัตว์เลี้ยงตามบ้าน</p>
        <div class="flex justify-between w-full px-5">
            <div class="flex flex-col">
                <h1 class="text-[1.7rem] font-bold">ดูแลสัตว์ที่บ้าน</h1>
                <p class="text-[1rem] text-gray-600">รายละเอียดงาน</p>
            </div>
            <i class="fa-solid fa-xmark fa-2x" onclick="closepopup()"></i>
        </div>
        <div class="w-full h-[2px] bg-gray-300 mt-5 mb-2"></div>
        <h1 class="text-[1.5rem] font-semibold px-5 py-3">รายละเอียดงาน</h1>
        <div class="grid grid-cols-3 gap-3 w-full px-10">
            <div>
                <p class="text-gray-600">ที่อยู่</p>
                <p class="text-[1.1rem]">1 ซอย ฉลองกรุง 1 แขวงลาดกระบัง เขตลาดกระบัง กรุงเทพมหานคร 10520</p>
            </div>
            <div>
                <p class="text-gray-600">วันที่</p>
                <p class="text-[1.1rem]">01/12/2025 - 04/12/2025</p>
            </div>
            <div>
                <p class="text-gray-600">เวลา</p>
                <p class="text-[1.1rem]">10:00 - 20:00</p>
            </div>
            <div>
                <p class="text-gray-600">จำนวนวัน</p>
                <p class="text-[1.1rem]">3 วัน</p>
            </div>
            <div>
                <p class="text-gray-600">งบประมาณ</p>
                <p class="text-[1.1rem]">4,500 บาท</p>
            </div>
        </div>
        <h1 class="text-[1.5rem] font-semibold px-5 py-3">ข้อมูลสัตว์</h1>
        <div class="grid grid-cols-3 gap-3 w-full px-10">
            <div>
                <p class="text-gray-600">ชื่อ (ชนิด - สายพันธุ์)</p>
                <p class="text-[1.1rem]">Max (หมา - โกลเด้น)</p>
            </div>
            <div>
                <p class="text-gray-600">อายุ</p>
                <p class="text-[1.1rem]">5 ปี</p>
            </div>
            <div>
                <p class="text-gray-600">น้ำหนัก</p>
                <p class="text-[1.1rem]">20 กก.</p>
            </div>
            <div>
                <p class="text-gray-600">ลักษณะนิสัย</p>
                <p class="text-[1.1rem]">เฟรนลี่</p>
            </div>
            <div>
                <p class="text-gray-600">อาหารและยา</p>
                <p class="text-[1.1rem]">ไม่มี</p>
            </div>
            <div>
                <p class="text-gray-600">สุขภาพ</p>
                <p class="text-[1.1rem]">ปวดตามข้อเข่า ให้วิ่งมากไม่ได้ ห้ามกระโดดลงสระน้ำ พาเดินเล่นได้นิดหน่อย</p>
            </div>
        </div>
        <div class="w-full h-[2px] bg-gray-300 my-5"></div>
        <div class="w-full flex justify-end items-end gap-5 px-5">
            <button onclick="closepopup()" class="px-7 py-2 bg-white text-blue-600 border border-blue-600 rounded-xl shadow-sm cursor-pointer transition duration-200 ease-in-out hover:bg-blue-50">ปฏิเสธ</button>
            <button onclick="closepopup()" class="px-7 py-2 bg-blue-600 border border-blue-600 text-white rounded-xl shadow-sm cursor-pointer transition duration-200 ease-in-out hover:bg-blue-800">ยืนยัน</button>
        </div>
    </div>

        <script>
            function card(job) {
                const id = job.booking_id || job.id;
                const customer = job.User?.full_name || `ผู้ใช้ #${job.user_id || ''}`;
                const svc = job.Service?.service_type || job.service_type || '-';
                const s = job.start_date ? new Date(job.start_date) : null;
                const e = job.end_date ? new Date(job.end_date) : null;
                const period = s && e ? `${s.toLocaleDateString()} - ${e.toLocaleDateString()}` : '-';
                const price = Number(job.total_price || job.Service?.price_per_hour || 0).toLocaleString();
                const status = job.status;
                return `
                    <div class="flex flex-col p-5 border border-gray-300 rounded-xl shadow-sm">
                        <div class="flex justify-between mb-3">
                            <p class="text-[1.3rem] font-semibold">งาน #${id}</p>
                            <p class="px-3 py-1 ${status==='completed'?'bg-green-100 text-green-800':status==='accepted'?'bg-yellow-100 text-yellow-800':'bg-blue-100 text-blue-800'} rounded-full">${status}</p>
                        </div>
                        <div class="grid grid-cols-4">
                            <p class="flex flex-col"><span class="text-gray-600">ลูกค้า</span><span>${customer}</span></p>
                            <p class="flex flex-col"><span class="text-gray-600">บริการ</span><span>${svc}</span></p>
                            <p class="flex flex-col"><span class="text-gray-600">วันที่</span><span>${period}</span></p>
                            <p class="flex flex-col"><span class="text-gray-600">ราคา</span><span>${price} บาท</span></p>
                        </div>
                        <div class="w-full flex justify-end items-end gap-3 mt-5">
                            <a class="px-5 py-2 bg-blue-600 text-white rounded-xl hover:bg-blue-800" href="/petsitter/work/${id}">ดูรายละเอียด</a>
                            ${status==='accepted'?`<button data-complete="${id}" class="px-5 py-2 bg-green-100 text-green-800 rounded-xl hover:bg-green-200">ทำงานเสร็จ</button>`:''}
                        </div>
                    </div>`;
            }
            async function loadMyJobs() {
                const newJobsEl = document.getElementById('new-jobs');
                const historyEl = document.getElementById('history');
                newJobsEl.innerHTML = '<p class="text-gray-500">กำลังโหลด...</p>';
                historyEl.innerHTML = '<p class="text-gray-500">กำลังโหลด...</p>';
                try {
                      const resp = await fetch('/petsitter/api/my-jobs?status=accepted');
                      const completedResp = await fetch('/petsitter/api/my-jobs?status=completed');
                    const [accData, compData] = await Promise.all([resp.json(), completedResp.json()]);
                    const acc = accData.jobs || accData.bookings || [];
                    const comp = compData.jobs || compData.bookings || [];
                    newJobsEl.innerHTML = acc.length ? acc.map(card).join('') : '<p class="text-gray-500">ไม่มีงานใหม่</p>';
                    historyEl.innerHTML = comp.length ? comp.map(card).join('') : '<p class="text-gray-500">ยังไม่มีประวัติงาน</p>';
                    // wire complete buttons
                    document.querySelectorAll('[data-complete]').forEach(btn => {
                        btn.addEventListener('click', async (e) => {
                            const id = e.currentTarget.getAttribute('data-complete');
                            const resp = await fetch(`/petsitter/api/jobs/${id}/status`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ status: 'completed' }) });
                            if (resp.ok) loadMyJobs();
                            else alert('อัปเดตสถานะไม่สำเร็จ');
                        });
                    });
                } catch (e) {
                    newJobsEl.innerHTML = '<p class="text-red-500">โหลดไม่สำเร็จ</p>';
                    historyEl.innerHTML = '<p class="text-red-500">โหลดไม่สำเร็จ</p>';
                }
            }
            loadMyJobs();
        </script>
</body>
</html>