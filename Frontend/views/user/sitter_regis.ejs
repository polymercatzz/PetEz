<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@100..900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body{
            font-family: "Noto Sans Thai", sans-serif;
        }
    </style>
</head>
<body>
    <%- include('../partials/user-nav') %>

    <div class="flex flex-col justify-center items-start my-10 mx-auto px-10 py-10 w-[80%] border border-gray-200 rounded-xl shadow-sm">
        <h1 class="text-[1.8rem] font-bold mb-5">สมัครเป็นพี่เลี้ยงสัตว์</h1>
        <div class="w-full mb-4">
            <label for="" class="flex items-center gap-3 text-lg">คำนำหน้าชื่อ</label>
            <select name="" id="title" class="w-full border-2 border-[#e2e8f0] rounded-2xl text-[1rem] px-5 py-2 transition duration-300 ease-in-out focus:outline-none focus:border-[#3b5bdb] focus:shadow-[0_0_0_4px_rgba(59,91,219,0.1)]">
                    <option value="" disabled selected>เลือกคำนำหน้าชื่อ</option>
                    <option value="">นาย</option>
                    <option value="">นางสาว</option>
                    <option value="">นาง</option>
            </select>
        </div>
        <div class="w-full grid grid-cols-3 gap-5 mb-4">
            <div class="w-full">
                <% first_name = user.full_name.split(' ')[0] %>
                <label for="" class="flex items-center gap-3 text-lg">ชื่อ</label>
                <input id="firstName" type="text" placeholder="กรุณาใส่ชื่อ" value="<%= first_name || '' %>" readonly class="w-full bg-gray-100 border-2 border-[#e2e8f0] rounded-2xl text-[1rem] px-5 py-2" />
            </div>
            <div class="w-full">
                <% last_name = user.full_name.split(' ')[1] %>
                <label for="" class="flex items-center gap-3 text-lg">นามสกุล</label>
                <input id="lastName" type="text" placeholder="กรุณาใส่นามสกุล" value="<%= last_name || '' %>" readonly class="w-full bg-gray-100 border-2 border-[#e2e8f0] rounded-2xl text-[1rem] px-5 py-2" />
            </div>
            <div class="w-full">
                <label for="" class="flex items-center gap-3 text-lg">อายุ</label>
                <input id="age" type="number" placeholder="กรุณาใส่อายุ" value="<%= user?.age || '' %>" readonly class="w-full bg-gray-100 border-2 border-[#e2e8f0] rounded-2xl text-[1rem] px-5 py-2" />
            </div>
            <div class="w-full">
                <label for="" class="flex items-center gap-3 text-lg">เบอร์โทรศัพท์</label>
                <input id="phone" type="text" placeholder="กรุณาใส่เบอร์โทรศัพท์" value="<%= user?.phone || '' %>" readonly class="w-full bg-gray-100 border-2 border-[#e2e8f0] rounded-2xl text-[1rem] px-5 py-2" />
            </div>
            <div class="w-full">
                <label for="" class="flex items-center gap-3 text-lg">Email</label>
                <input id="email" type="email" placeholder="กรุณาใส่ Email" value="<%= user?.email || '' %>" readonly class="w-full bg-gray-100 border-2 border-[#e2e8f0] rounded-2xl text-[1rem] px-5 py-2" />
            </div>
        </div>
        <div class="mb-4 w-full">
            <label class="block mb-1 text-gray-700 font-medium">ที่อยู่</label>
            <textarea id="address" placeholder="สถานที่ที่ให้ไปบริการ" class="w-full border-2 border-[#e2e8f0] rounded-2xl text-[1rem] px-5 py-2"><%= user?.address || '' %></textarea>
        </div>
        <div class="w-full grid grid-cols-3 gap-5 mb-4">
            <div class="w-full">
                <label for="" class="flex items-center gap-3 text-lg">เขต/อำเภอ</label>
                <input id="district" type="text" placeholder="กรุณาใส่เขต/อำเภอ" class="w-full border-2 border-[#e2e8f0] rounded-2xl text-[1rem] px-5 py-2 transition duration-300 ease-in-out focus:outline-none focus;border-[#3b5bdb] focus:shadow-[0_0_0_4px_rgba(59,91,219,0.1)]" />
            </div>
            <div class="w-full">
                <label for="" class="flex items-center gap-3 text-lg">จังหวัด</label>
                <input id="province" type="text" placeholder="กรุณาใส่จังหวัด" class="w-full border-2 border-[#e2e8f0] rounded-2xl text-[1rem] px-5 py-2 transition duration-300 ease-in-out focus:outline-none focus:border-[#3b5bdb] focus:shadow-[0_0_0_4px_rgba(59,91,219,0.1)]" />
            </div>
            <div class="w-full">
                <label for="" class="flex items-center gap-3 text-lg">รหัสไปรษณีย์</label>
                <input id="postalCode" type="text" placeholder="กรุณาใส่รหัสไปรษณีย์" class="w-full border-2 border-[#e2e8f0] rounded-2xl text-[1rem] px-5 py-2 transition duration-300 ease-in-out focus:outline-none focus:border-[#3b5bdb] focus:shadow-[0_0_0_4px_rgba(59,91,219,0.1)]" />
            </div>
        </div>
        <h1 class="text-[1.8rem] font-bold mb-5">เอกสารต่าง ๆ</h1>
        <div class="w-full grid grid-cols-3 gap-5 mb-4">
            <div class="w-full">
                <label for="" class="flex items-center gap-3 text-lg">สำเนาบัตรประชาชน</label>
                <div class="w-full">
                    <label class="flex flex-col items-start justify-center w-full h-12 px-4 py-2 bg-white border-2 border-[#e2e8f0] rounded-2xl text-gray-600 cursor-pointer hover:border-[#3b5bdb] hover:shadow-md transition duration-300 ease-in-out">
                            <span>คลิกเพื่ออัปโหลดไฟล์</span>
                            <input id="idCardFile" type="file" class="hidden" />
                        </label>
                </div>
            </div>
        </div>
        <div class="flex justify-end items-end gap-5 w-full mt-5">
            <a href="/user/"><button class="border border-vlue-600 bg-white px-10 py-2 text-blue-600 text-[1.2rem] rounded-xl cursor-pointer transition deration-200 ease-in-out hadow-[0_5px_15px_rgba(37,99,235,0.3)] hover:shadow-[0_8px_20px_rgba(37,99,235,0.4)] hover:border-blue-500">ยกเลิก</button></a>
            <button id="sitterSubmit" type="button" class="bg-blue-600 px-10 py-2 text-white text-[1.2rem] rounded-xl shadow-sm cursor-pointer transition deration-200 ease-in-out hover:bg-blue-800">ยืนยัน</button>
        </div>
    </div>
    <script>
        // Handle ID card upload to local storage
        const idCardInput = document.getElementById('idCardFile');
        let idCardPath = null;
        if (idCardInput) {
            idCardInput.addEventListener('change', async () => {
                const file = idCardInput.files?.[0];
                if (!file) return;
                const formData = new FormData();
                formData.append('id_card', file);
                try {
                    const resp = await fetch('/user/api/sitter/upload-id', { method: 'POST', body: formData });
                    const data = await resp.json();
                    if (resp.ok) {
                        idCardPath = data.path;
                        alert('อัปโหลดสำเนาบัตรประชาชนสำเร็จ');
                    } else {
                        alert(data.message || 'อัปโหลดไฟล์ไม่สำเร็จ');
                    }
                } catch (e) {
                    alert('เกิดข้อผิดพลาดในการอัปโหลดไฟล์');
                }
            });
        }

        // Submit sitter registration to backend
        document.getElementById('sitterSubmit').addEventListener('click', async () => {
            const title = document.getElementById('title').value.trim();
            const firstName = document.getElementById('firstName').value.trim();
            const lastName = document.getElementById('lastName').value.trim();
            const age = document.getElementById('age').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const email = document.getElementById('email').value.trim();
            const address = document.getElementById('address').value.trim();
            const district = document.getElementById('district').value.trim();
            const province = document.getElementById('province').value.trim();
            const postalCode = document.getElementById('postalCode').value.trim();

            if (!firstName || !lastName || !age || !phone) {
                alert('กรุณากรอกข้อมูลที่จำเป็นให้ครบถ้วน');
                return;
            }

            // Map sitter payload expected by sitter-service (now uses user_id, experience, id_card_doc)
            const payload = {
                id_card_doc: idCardPath,
            };
            try {
                const resp = await fetch('/user/api/sitter/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (resp.ok) {
                    alert('ส่งคำขอสมัครพี่เลี้ยงสำเร็จ');
                    // After registering, send the user to sitter home
                    window.location.href = '/user/';
                } else {
                    const err = await resp.json().catch(() => ({ message: 'สมัครไม่สำเร็จ' }));
                    alert(err.message || 'สมัครไม่สำเร็จ');
                }
            } catch (e) {
                alert('เกิดข้อผิดพลาดในการเชื่อมต่อ');
            }
        });
    </script>
</body>
</html>