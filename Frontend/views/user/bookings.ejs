<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Bookings - PetEz</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@100..900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body{
            font-family: "Noto Sans Thai", sans-serif;
        }
    </style>
</head>
<body class="bg-[#F9F9FB]">
    <%- include('../partials/user-nav') %>

    <div class="max-w-6xl mx-auto mt-10 px-6">
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800">
                <i class="fa-solid fa-calendar-check mr-3 text-blue-600"></i>
                การจองของฉัน
            </h1>
            <div class="flex gap-3">
                <a href="/user/history" class="bg-gray-600 text-white px-6 py-3 rounded-lg hover:bg-gray-700 transition duration-200">
                    <i class="fa-solid fa-history mr-2"></i>
                    ดูประวัติการจอง
                </a>
                <a href="/user/create-booking" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition duration-200">
                    <i class="fa-solid fa-plus mr-2"></i>
                    สร้างการจองใหม่
                </a>
            </div>
        </div>

        <div id="bookingsContainer" class="space-y-6">
            <% if (bookings && bookings.length > 0) { %>
                <% bookings.forEach(function(booking) { %>
                    <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 <%= booking.status === 'confirmed' ? 'border-green-500' : booking.status === 'pending' ? 'border-yellow-500' : booking.status === 'cancelled' ? 'border-red-500' : 'border-blue-500' %>">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="flex items-center gap-4 mb-4">
                                    <h3 class="text-xl font-semibold text-gray-800">การจอง #<%= booking.booking_id %></h3>
                                    <span class="px-3 py-1 rounded-full text-sm font-medium
                                        <%= booking.status === 'confirmed' ? 'bg-green-100 text-green-800' : 
                                            booking.status === 'pending' ? 'bg-yellow-100 text-yellow-800' : 
                                            booking.status === 'cancelled' ? 'bg-red-100 text-red-800' :
                                            booking.status === 'in_progress' ? 'bg-blue-100 text-blue-800' :
                                            'bg-gray-100 text-gray-800' %>">
                                        <%= booking.status === 'confirmed' ? 'ยืนยันแล้ว' : 
                                            booking.status === 'pending' ? 'รอยืนยัน' : 
                                            booking.status === 'cancelled' ? 'ยกเลิกแล้ว' :
                                            booking.status === 'in_progress' ? 'กำลังดำเนินการ' :
                                            booking.status === 'completed' ? 'เสร็จสิ้น' : booking.status %>
                                    </span>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                                    <div>
                                        <p class="text-sm text-gray-500 mb-1">ประเภทบริการ</p>
                                        <p class="font-semibold">
                                            <%= booking.service_type === 'sitting' ? 'ดูแลสัตว์เลี้ยง' : 
                                                booking.service_type === 'walking' ? 'พาเดิน' : 
                                                booking.service_type === 'boarding' ? 'ฝากเลี้ยง' :
                                                booking.service_type === 'grooming' ? 'ตัดแต่งขน' : booking.service_type %>
                                        </p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-500 mb-1">วันที่เริ่ม</p>
                                        <p class="font-semibold"><%= new Date(booking.start_date).toLocaleDateString('th-TH') %></p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-500 mb-1">วันที่สิ้นสุด</p>
                                        <p class="font-semibold"><%= new Date(booking.end_date).toLocaleDateString('th-TH') %></p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-500 mb-1">ราคารวม</p>
                                        <p class="font-semibold text-green-600">฿<%= booking.total_price %></p>
                                    </div>
                                </div>

                                <% if (booking.special_instructions) { %>
                                    <div class="mb-4">
                                        <p class="text-sm text-gray-500 mb-1">คำแนะนำพิเศษ</p>
                                        <p class="text-gray-700"><%= booking.special_instructions %></p>
                                    </div>
                                <% } %>

                                <% if (booking.location) { %>
                                    <div class="mb-4">
                                        <p class="text-sm text-gray-500 mb-1">สถานที่</p>
                                        <p class="text-gray-700">
                                            <i class="fa-solid fa-location-dot mr-1"></i>
                                            <%= booking.location %>
                                        </p>
                                    </div>
                                <% } %>
                            </div>

                            <div class="flex gap-2 ml-4">
                                <% if (booking.status === 'pending' || booking.status === 'confirmed') { %>
                                    <button onclick="editBooking(<%= booking.booking_id %>)" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition duration-200">
                                        <i class="fa-solid fa-edit"></i>
                                        แก้ไข
                                    </button>
                                    <button onclick="cancelBooking(<%= booking.booking_id %>)" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition duration-200">
                                        <i class="fa-solid fa-times"></i>
                                        ยกเลิก
                                    </button>
                                <% } %>
                            </div>
                        </div>
                    </div>
                <% }); %>
            <% } else { %>
                <div class="text-center py-12">
                    <i class="fa-solid fa-calendar-xmark text-6xl text-gray-300 mb-4"></i>
                    <h3 class="text-xl font-semibold text-gray-500 mb-2">ยังไม่มีการจอง</h3>
                    <p class="text-gray-400 mb-6">คุณยังไม่มีการจองใดๆ เริ่มสร้างการจองแรกของคุณได้เลย</p>
                    <a href="/user/create-booking" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition duration-200">
                        <i class="fa-solid fa-plus mr-2"></i>
                        สร้างการจองใหม่
                    </a>
                </div>
            <% } %>
        </div>
    </div>

    <!-- Success/Error Messages -->
    <div id="alertContainer" class="fixed top-4 right-4 z-50"></div>

    <script>
        // Edit booking
        function editBooking(bookingId) {
            // Redirect to edit booking page
            window.location.href = `/user/edit-booking/${bookingId}`;
        }

        // Cancel booking
        async function cancelBooking(bookingId) {
            if (!confirm('คุณแน่ใจหรือไม่ที่จะยกเลิกการจองนี้?')) {
                return;
            }

            try {
                const response = await fetch(`/user/api/bookings/${bookingId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showAlert('ยกเลิกการจองเรียบร้อยแล้ว!', 'success');
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    const data = await response.json();
                    showAlert(data.message || 'เกิดข้อผิดพลาดในการยกเลิกการจอง', 'error');
                }
            } catch (error) {
                console.error('Error cancelling booking:', error);
                showAlert('เกิดข้อผิดพลาดในการยกเลิกการจอง', 'error');
            }
        }

        // Show alert messages
        function showAlert(message, type) {
            const alertContainer = document.getElementById('alertContainer');
            const alertDiv = document.createElement('div');
            
            let bgColor = 'bg-gray-500';
            if (type === 'success') bgColor = 'bg-green-500';
            else if (type === 'error') bgColor = 'bg-red-500';
            else if (type === 'info') bgColor = 'bg-blue-500';
            
            alertDiv.className = `${bgColor} text-white px-6 py-3 rounded-lg shadow-lg mb-2`;
            alertDiv.innerHTML = `
                <div class="flex items-center justify-between">
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-white hover:text-gray-200">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            alertContainer.appendChild(alertDiv);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }
    </script>
</body>
</html>