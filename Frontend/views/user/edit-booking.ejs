<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %> - PetEz</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@100..900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body{
            font-family: "Noto Sans Thai", sans-serif;
        }
    </style>
</head>
<body class="bg-[#F9F9FB]">
    <%- include('../partials/user-nav') %>

    <div class="max-w-4xl mx-auto mt-10 px-6">
        <div class="mb-8">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800">
                        <i class="fa-solid fa-edit mr-3 text-blue-600"></i>
                        แก้ไขการจอง #<%= booking.booking_id %>
                    </h1>
                    <p class="text-gray-600 mt-2">แก้ไขข้อมูลการจองดูแลสัตว์เลี้ยงของคุณ</p>
                </div>
                <div>
                    <span class="px-4 py-2 rounded-full text-sm font-medium 
                        <% if (booking.status === 'pending') { %>bg-yellow-100 text-yellow-800<% } 
                        else if (booking.status === 'confirmed') { %>bg-blue-100 text-blue-800<% } 
                        else if (booking.status === 'completed') { %>bg-green-100 text-green-800<% } 
                        else if (booking.status === 'cancelled') { %>bg-red-100 text-red-800<% } 
                        else { %>bg-gray-100 text-gray-800<% } %>">
                        <% if (booking.status === 'pending') { %>รอดำเนินการ<% } 
                        else if (booking.status === 'confirmed') { %>ยืนยันแล้ว<% } 
                        else if (booking.status === 'completed') { %>สำเร็จ<% } 
                        else if (booking.status === 'cancelled') { %>ยกเลิก<% } 
                        else { %><%= booking.status %><% } %>
                    </span>
                </div>
            </div>
        </div>

        <!-- Alert Container -->
        <div id="alertContainer" class="fixed top-4 right-4 z-50"></div>

        <form id="editBookingForm" class="bg-white rounded-xl shadow-lg p-8">
            <input type="hidden" name="booking_id" value="<%= booking.booking_id %>">
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <!-- Pet Selection -->
                <div class="col-span-full">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fa-solid fa-paw mr-2 text-blue-600"></i>
                        เลือกสัตว์เลี้ยง <span class="text-red-500">*</span>
                    </label>
                    <select name="pet_id" required class="w-full border-2 border-gray-200 rounded-lg px-4 py-3 focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
                        <option value="">-- เลือกสัตว์เลี้ยง --</option>
                        <% if (userPets && userPets.length > 0) { %>
                            <% userPets.forEach(function(pet) { %>
                                <option value="<%= pet.pet_id %>" <%= booking.pet_id == pet.pet_id ? 'selected' : '' %>>
                                    <%= pet.name %> - <%= pet.type %>
                                </option>
                            <% }); %>
                        <% } %>
                    </select>
                    <% if (!userPets || userPets.length === 0) { %>
                        <p class="text-sm text-red-500 mt-1">
                            คุณยังไม่มีสัตว์เลี้ยงในระบบ 
                            <a href="/user/profile" class="text-blue-600 hover:underline">เพิ่มสัตว์เลี้ยงก่อน</a>
                        </p>
                    <% } %>
                </div>

                <!-- Service Type -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fa-solid fa-hands-helping mr-2 text-blue-600"></i>
                        ประเภทบริการ <span class="text-red-500">*</span>
                    </label>
                    <select name="service_type" required class="w-full border-2 border-gray-200 rounded-lg px-4 py-3 focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
                        <option value="sitting" <%= booking.service_type === 'sitting' ? 'selected' : '' %>>ดูแลสัตว์เลี้ยง</option>
                        <option value="walking" <%= booking.service_type === 'walking' ? 'selected' : '' %>>พาเดิน</option>
                        <option value="boarding" <%= booking.service_type === 'boarding' ? 'selected' : '' %>>ฝากเลี้ยง</option>
                        <option value="grooming" <%= booking.service_type === 'grooming' ? 'selected' : '' %>>ตัดแต่งขน</option>
                    </select>
                </div>

                <!-- Price per Hour -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fa-solid fa-dollar-sign mr-2 text-blue-600"></i>
                        ราคาต่อชั่วโมง (บาท) <span class="text-red-500">*</span>
                    </label>
                    <input type="number" name="price_per_hour" min="1" step="0.01" value="<%= booking.price_per_hour || 50 %>" required 
                           class="w-full border-2 border-gray-200 rounded-lg px-4 py-3 focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200"
                           placeholder="50.00">
                </div>

                <!-- Start Date -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fa-solid fa-calendar-day mr-2 text-blue-600"></i>
                        วันที่เริ่ม <span class="text-red-500">*</span>
                    </label>
                    <input type="datetime-local" name="start_date" required 
                           value="<%= new Date(booking.start_date).toISOString().slice(0, 16) %>"
                           class="w-full border-2 border-gray-200 rounded-lg px-4 py-3 focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
                </div>

                <!-- End Date -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fa-solid fa-calendar-check mr-2 text-blue-600"></i>
                        วันที่สิ้นสุด <span class="text-red-500">*</span>
                    </label>
                    <input type="datetime-local" name="end_date" required 
                           value="<%= new Date(booking.end_date).toISOString().slice(0, 16) %>"
                           class="w-full border-2 border-gray-200 rounded-lg px-4 py-3 focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
                </div>

                <!-- Location -->
                <div class="col-span-full">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fa-solid fa-map-marker-alt mr-2 text-blue-600"></i>
                        สถานที่ให้บริการ
                    </label>
                    <input type="text" name="location" value="<%= booking.location || '' %>"
                           class="w-full border-2 border-gray-200 rounded-lg px-4 py-3 focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200"
                           placeholder="บ้านของคุณ, สวนสาธารณะ, ฯลฯ">
                </div>

                <!-- Emergency Contact -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fa-solid fa-phone mr-2 text-blue-600"></i>
                        เบอร์ติดต่อฉุกเฉิน
                    </label>
                    <input type="tel" name="emergency_contact" value="<%= booking.emergency_contact || '' %>"
                           class="w-full border-2 border-gray-200 rounded-lg px-4 py-3 focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200"
                           placeholder="0XX-XXX-XXXX">
                </div>

                <!-- Total Hours (Read-only, calculated) -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fa-solid fa-clock mr-2 text-blue-600"></i>
                        จำนวนชั่วโมงทั้งหมด
                    </label>
                    <input type="number" name="total_hours" value="<%= booking.total_hours || 0 %>" readonly
                           class="w-full border-2 border-gray-200 rounded-lg px-4 py-3 bg-gray-100 cursor-not-allowed"
                           placeholder="คำนวณอัตโนมัติ">
                </div>

                <!-- Special Instructions -->
                <div class="col-span-full">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fa-solid fa-comment-alt mr-2 text-blue-600"></i>
                        คำแนะนำพิเศษ
                    </label>
                    <textarea name="special_instructions" rows="4"
                              class="w-full border-2 border-gray-200 rounded-lg px-4 py-3 focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200"
                              placeholder="อธิบายความต้องการพิเศษสำหรับการดูแลสัตว์เลี้ยงของคุณ..."><%= booking.special_instructions || '' %></textarea>
                </div>
            </div>

            <!-- Price Calculation -->
            <div class="bg-blue-50 rounded-lg p-6 mb-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">
                    <i class="fa-solid fa-calculator mr-2 text-blue-600"></i>
                    สรุปค่าใช้จ่าย
                </h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                    <div>
                        <p class="text-sm text-gray-600">ราคาต่อชั่วโมง</p>
                        <p class="text-xl font-bold text-blue-600" id="displayPricePerHour"><%= booking.price_per_hour || 50 %> บาท</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">จำนวนชั่วโมง</p>
                        <p class="text-xl font-bold text-blue-600" id="displayTotalHours"><%= booking.total_hours || 0 %> ชม.</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">ราคารวม</p>
                        <p class="text-2xl font-bold text-green-600" id="displayTotalPrice"><%= booking.total_price || 0 %> บาท</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">สถานะ</p>
                        <p class="text-lg font-bold text-gray-700">
                            <% if (booking.status === 'pending') { %>รอดำเนินการ<% } 
                            else if (booking.status === 'confirmed') { %>ยืนยันแล้ว<% } 
                            else if (booking.status === 'completed') { %>สำเร็จ<% } 
                            else if (booking.status === 'cancelled') { %>ยกเลิก<% } 
                            else { %><%= booking.status %><% } %>
                        </p>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex flex-col sm:flex-row gap-4 justify-end">
                <a href="/user/bookings" class="px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition duration-200 text-center">
                    <i class="fa-solid fa-arrow-left mr-2"></i>ยกเลิก
                </a>
                <% if (booking.status === 'pending' || booking.status === 'confirmed') { %>
                    <button type="submit" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-200">
                        <i class="fa-solid fa-save mr-2"></i>บันทึกการแก้ไข
                    </button>
                <% } else { %>
                    <div class="px-6 py-3 bg-gray-300 text-gray-500 rounded-lg cursor-not-allowed text-center">
                        <i class="fa-solid fa-lock mr-2"></i>ไม่สามารถแก้ไขได้
                    </div>
                <% } %>
            </div>
        </form>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('editBookingForm');
            const startDateInput = form.querySelector('input[name="start_date"]');
            const endDateInput = form.querySelector('input[name="end_date"]');
            const pricePerHourInput = form.querySelector('input[name="price_per_hour"]');
            const totalHoursInput = form.querySelector('input[name="total_hours"]');

            // Set minimum dates to current time
            const now = new Date();
            const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
            
            // Only set minimum for future bookings
            const startDate = new Date(startDateInput.value);
            if (startDate > now) {
                startDateInput.min = localDateTime;
                endDateInput.min = localDateTime;
            }

            // Calculate total hours and price
            function calculateTotalAndPrice() {
                const startDate = new Date(startDateInput.value);
                const endDate = new Date(endDateInput.value);
                const pricePerHour = parseFloat(pricePerHourInput.value) || 0;

                if (startDate && endDate && endDate > startDate) {
                    const diffTime = Math.abs(endDate - startDate);
                    const diffHours = Math.ceil(diffTime / (1000 * 60 * 60));
                    const totalPrice = diffHours * pricePerHour;

                    totalHoursInput.value = diffHours;
                    document.getElementById('displayTotalHours').textContent = diffHours + ' ชม.';
                    document.getElementById('displayTotalPrice').textContent = totalPrice.toLocaleString() + ' บาท';
                    document.getElementById('displayPricePerHour').textContent = pricePerHour.toLocaleString() + ' บาท';
                } else {
                    totalHoursInput.value = 0;
                    document.getElementById('displayTotalHours').textContent = '0 ชม.';
                    document.getElementById('displayTotalPrice').textContent = '0 บาท';
                }
            }

            // Add event listeners
            startDateInput.addEventListener('change', calculateTotalAndPrice);
            endDateInput.addEventListener('change', calculateTotalAndPrice);
            pricePerHourInput.addEventListener('input', calculateTotalAndPrice);

            // Initial calculation
            calculateTotalAndPrice();

            // Handle form submission
            form.addEventListener('submit', async function(e) {
                e.preventDefault();

                const formData = new FormData(form);
                const bookingData = {
                    pet_id: parseInt(formData.get('pet_id')),
                    service_type: formData.get('service_type'),
                    start_date: formData.get('start_date'),
                    end_date: formData.get('end_date'),
                    total_hours: parseInt(formData.get('total_hours')),
                    price_per_hour: parseFloat(formData.get('price_per_hour')),
                    total_price: parseInt(formData.get('total_hours')) * parseFloat(formData.get('price_per_hour')),
                    location: formData.get('location'),
                    emergency_contact: formData.get('emergency_contact'),
                    special_instructions: formData.get('special_instructions')
                };

                try {
                    const bookingId = formData.get('booking_id');
                    const response = await fetch(`/user/api/bookings/${bookingId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(bookingData)
                    });

                    if (response.ok) {
                        showAlert('แก้ไขการจองเรียบร้อยแล้ว!', 'success');
                        setTimeout(() => {
                            window.location.href = '/user/bookings';
                        }, 1500);
                    } else {
                        const errorData = await response.json();
                        showAlert(errorData.message || 'เกิดข้อผิดพลาดในการแก้ไขการจอง', 'error');
                    }
                } catch (error) {
                    console.error('Error updating booking:', error);
                    showAlert('เกิดข้อผิดพลาดในการเชื่อมต่อเซิร์ฟเวอร์', 'error');
                }
            });
        });

        // Show alert messages
        function showAlert(message, type) {
            const alertContainer = document.getElementById('alertContainer');
            const alertDiv = document.createElement('div');
            
            let bgColor = 'bg-gray-500';
            if (type === 'success') bgColor = 'bg-green-500';
            else if (type === 'error') bgColor = 'bg-red-500';
            else if (type === 'info') bgColor = 'bg-blue-500';
            
            alertDiv.className = `${bgColor} text-white px-6 py-3 rounded-lg shadow-lg mb-2`;
            alertDiv.innerHTML = `
                <div class="flex items-center justify-between">
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-white hover:text-gray-200">
                        <i class="fa-solid fa-times"></i>
                    </button>
                </div>
            `;
            
            alertContainer.appendChild(alertDiv);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }
    </script>
</body>
</html>