events {
    worker_connections 1024;
}

http {
    # Upstream blocks for microservices (auto-scales via Docker DNS)
    upstream auth_backend {
        least_conn;
        server auth-service:3002;
    }

    upstream booking_backend {
        least_conn;
        server booking-service:3006;
    }

    upstream sitter_backend {
        least_conn;
        server sitter-service:3004;
    }

    upstream payment_backend {
        least_conn;
        server payment-service:3007;
    }

    upstream frontend_app {
        least_conn;
        server frontend:3001;
    }

    # Main server block
    server {
        listen 80;

        # --- API Routing ---
        location /api/auth/ {
            rewrite ^/api/(.*) /$1 break;
            proxy_pass http://auth_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_connect_timeout 5s;
            proxy_send_timeout 10s;
            proxy_read_timeout 10s;
        }

        location /api/booking/ {
            rewrite ^/api/(.*) /$1 break;
            proxy_pass http://booking_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_connect_timeout 5s;
            proxy_send_timeout 10s;
            proxy_read_timeout 10s;
        }

        location /api/sitter/ {
            rewrite ^/api/(.*) /$1 break;
            proxy_pass http://sitter_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_connect_timeout 5s;
            proxy_send_timeout 10s;
            proxy_read_timeout 10s;
        }

        location /api/payment/ {
            rewrite ^/api/(.*) /$1 break;
            proxy_pass http://payment_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_connect_timeout 5s;
            proxy_send_timeout 10s;
            proxy_read_timeout 10s;
        }

        # --- Frontend Catch-All ---
        location / {
            proxy_pass http://frontend_app;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            expires 1d;
            add_header Cache-Control "public, max-age=86400";
        }
    }
}
